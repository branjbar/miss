---
title: "EDA Over HiDER Results"
author: "Bijan Ranjbar-Sahraei"
date: "October 25, 2015"
output: html_document
---


# Introduction
This page presents the exploratary data analysis conducted on family networks generated by HiDER tool. The results not only confirm that the entity resolution task is performed well by HiDER but also provide new insights in data.

# Initialization
```{r}
rm(list=ls())
```

# Import Data
We start by importing the first csv files. Let's loop through all files in the directory and for each file add the data into *data* data frame.
```{r}
mypath = "/Users/bian/Dropbox/CATCH_Local/network_data/new_data/"
filenames=list.files(path=mypath, full.names=TRUE)
datalist = lapply(filenames, function(x){
  t <- read.csv(x,sep=';',row.names=NULL)
  # during the input procedure we get one extra 
  t$X <- NULL  
  
  # adding the depth information to each row
  if (grepl("depth2",x)) {
    t$depth <- 2  # main couple and up to 2nd neighbors
  }
  else
    t$depth <- 1  # main couple and its first neighbros
  
  return(t)
  })

data <- datalist[[1]]  # initialized the dataframe by first data vector
for (i in 1:length(filenames)) {  # CHANGE--> 2to1
  data <- rbind(data,datalist[[i]])
}

```

Let's look at columns and number of instances with depth 1 and depth 2
```{r}
colnames(data)

# number of rows related to depth 1 networks
nrow(data[data$depth==1,])

# number of rows related to depth 2 networks
nrow(data[data$depth==2,])

# number of networks with each depth
aggdata <- aggregate(row.names ~ network_no+depth, data, function(x) length(unique(x)))
aggregate(row.names ~ depth, aggdata, FUN=length)

```


# General Statistics
We know that networks of depth 1 should be much smaller than networks of size 2. Let's look at the distribution of these sizes.

```{r}
#install.packages("ggplot2")
library(ggplot2)

# count number of edges in each network
aggdata <- aggregate(row.names~network_no+depth, data=data, FUN=length)
aggdata$row.names <- aggdata$row.names-1  # to convert number of edges to number of nodes (note that our network doesn't have any loop)
aggdata$depth <- factor(aggdata$depth)

ggplot(aggdata, aes(x=row.names))  + 
#  geom_histogram(aes(y = ..density..,fill=depth),binwidth=1) +
  geom_density(aes(fill=depth, alpha=depth)) + 
  labs(x="Network Size", y="Freq.")
```

The average size of networks can be better seen in the following table and its following boxplot.

```{r}
# Size of networks with depth 1
summary(aggdata[aggdata$depth==1,]$row.names)

# Size of networks with depth 2
summary(aggdata[aggdata$depth==2,]$row.names)

ggplot(aggdata, aes(x=depth,y=row.names))  + 
  geom_boxplot() + 
  labs(x="Depth", y="Size")

```

# Searching for Anomalies 

For each network we'll extract some statitsitcs. For example number of children for each node, number of parents for each node, max number of parents, etc. A very significant sign of anomaly is the existance of more than two parent nodes for a child node. This is either due to a *False Positive* match in child node or a *False Negative* match in the parents node.


```{r}

# A useful function to approximate length of generations in each netowrk
get_generation_length <- function(net) {
  # this function gets a network and computes the number of years between oldest date and newest date
  
  date.min <- 10000
  date.max <- 0
  
  # check the source date
  dates <- net$source_date
  for (d in 1:length(dates)) {
    two_dates <- strsplit(as.character(dates[1]), '-')
    for (i in 1:2) {
      x <- as.double(two_dates[[1]][i])
      if (x<date.min) {date.min <- x}
      if (x>date.max) {date.max <- x}
    }
  }

  # check the target date
  dates <- net$target_date
  for (d in 1:length(dates)) {
    two_dates <- strsplit(as.character(dates[1]), '-')
    for (i in 1:2) {
      x <- as.double(two_dates[[1]][i])
      if (x<date.min) {date.min <- x}
      if (x>date.max) {date.max <- x}
    }
  }
  return(date.max - date.min)
}


# a usuful function to see how many certificates are merged to generate each node
library(stringr)

get_number_of_merged_certificates <- function(x) {
  count_list = vector()
  
  # check the source nodes
  source_ids <- x$source_id
  for (d in 1:length(source_ids)) {
    count_list = c(count_list, str_count(as.character(source_ids[d]),',')/2+1)
  }
  target_ids <- x$source_id
  for (d in 1:length(target_ids)) {
    if (d %in% source_ids) {
      count_list = c(count_list, str_count(as.character(target_ids[d]),',')/2+1)
    }
  }
  return(data.frame(avg=mean(count_list),max=max(count_list)))
  
}


# making an empty data frame for network
network <- data.frame(no=integer(), child.max=integer(), parent.max=integer(), anomalies=integer(), depth=factor(), generation_length=double())

# Looping through the networks
for (d in 1:1) {  # for each depth

  for (i in 1:max(data[data$depth==d,]$network_no) ){  # for each network number
    net <- subset(data,network_no==i & depth==d)  # net is the subset with network number *i* and depth *d*
    
    # we continue if subset is nonempty
    if (nrow(net) > 1) {  
      children <- aggregate(row.names~source, data=net, FUN=length)  # for each source we find the existing targets

      parents <- aggregate(row.names~target, data=net, FUN=length)  # for each target we find the existing sources
      
      gl <- get_generation_length(net)
      mc <- get_number_of_merged_certificates(net)
      
      
      # let's make an instance and store some useful data in
      instance <- data.frame(no=i,  # network number
                             child.max=max(children$row.names),  # maximum number of children for a node (at least in depth 1, it can be interpreted as number of children for the central couple)
                             parent.max=max(parents$row.names),  # maximum number of parents
                             anomalies=sum(parents$row.names>2),  # number of nodes with more than two parent
                             depth=d,  # depth of node
                             generation_length=gl,  # generation lenth
                             merged_avg=mc$avg,  # average merged documents per node
                             merged_max=mc$max  # maximum merged documents per node
      )
    
      # adding instance to network data frame
      network<-rbind(network,instance)
    }
  }
}

# let's turn depth to a factor format
network$depth <- factor(network$depth)

# this is how network looks like
head(network)
```

Having the *network* data frame, we can easily extract distributions and make nice boxplots.

Let's look at distribution of number of children 
```{r}
ggplot(data=network, aes(x=child.max,color=depth)) + geom_density() + labs(x="Number of Children", y="Freq.")
```

Here we show this distribution in form of a boxplot
```{r}
ggplot(data=network, aes(x=depth,y=child.max)) + geom_boxplot() + labs(x="Depth", y="Number of Children")
```

Distribution of maximum number of parent nodes which indictes the anomalies are shown in following figure.
```{r}
ggplot(data=network, aes(x=parent.max,fill=depth)) + geom_histogram(aes(y=..count../sum(..count..)),position="dodge") + labs(x="Number of Parents", y="Freq.")
```

Here we see the number of anomalies in a network.

```{r}
ggplot(data=network, aes(x=anomalies, fill=depth)) + geom_histogram(aes(y=..count../sum(..count..)),position="dodge") + labs(x="Number of Anomalies.",y="Freq.")
```

Finally Let's see how many networks are anomaly free which gives us an indication of average precision-recall.

```{r}
ggplot(data=network, aes(x=anomalies==0,fill=depth)) + geom_histogram(aes(y=2 *..count../sum(..count..)), position="dodge") + labs(x="Anomaly", y="Freq.")
``` 

The number of depth 1 networks with anomaly clearly explain the accuracy of our matches. This in 80% of cases we have a precise identity resolution. 

## Length of Generations

Another way to see the anomalies is to look at the range of years between very first document and last one. Let's look at the distribution of this range in following.

```{r}
ggplot(data=subset(network,generation_length<600)  # to get rid of outliers
       , aes(x=generation_length,color=depth)) + geom_density() + labs(x="Generation Length", y="Freq.")
```

Here we show this distribution in form of a boxplot
```{r}
ggplot(data=subset(network,generation_length<600)  # to get rid of outliers
       , aes(x=depth,y=generation_length)) + geom_boxplot() + labs(x="Depth", y="Generation Length")
```

## Number of Merged Documents (Matches found for a couple)

It's also important to see how many documents are merged two form a node.
```{r}
ggplot(data=network, aes(x=depth,y=merged_avg)) + geom_boxplot() + labs(x="Depth", y="Average Number of Merged Documents")
ggplot(data=network, aes(x=merged_max,color=depth)) + geom_density() + labs(x="Depth", y="Maximum Number of Merged Documents")
```

The maximum number of merged documents for depth 1 in the above figure exactly shows the number of matches we've find for each couple.

