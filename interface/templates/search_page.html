<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MiSS Intelligent Search Engine</title>

    <!-- Bootstrap core CSS -->
    <script src="../static/d3/d3.js"></script>



  </head>

  <body>
        <div id="tree"></div>

  </body>
        {% for b in dataset.leaves %}
            {{b.level}}, {{b.order}})    {{b.node1.name}} -- {{b.node2.name}}
            <br>
        {% endfor %}
        <br><br>
        {% for b in dataset.branches %}
            {{b.source.level}}, {{b.source.order}} --> {{b.target.level}}, {{b.target.order}}
            <br>
        {% endfor %}
        <script type="text/javascript">


            var dataset = []

            dataset = {{dataset|tojson|safe}}
            var level_index = [1,0,0,0,0,0,0,0]

            min_level = d3.min(dataset.leaves, function(d){return d.level})
            max_level = d3.max(dataset.leaves, function(d){return d.level})
            max_order = d3.max(dataset.leaves, function(d){return d.order})

            BLOCK_WIDTH = 200
            BLOCK_HEIGHT = 30
            WIDTH = (max_level - min_level + 1) * BLOCK_WIDTH * 1.5
            HEIGHT = max_order * BLOCK_HEIGHT * 1.5
            var x_scale = d3.scale.linear().domain([min_level,max_level]).range([10,WIDTH-BLOCK_WIDTH-2])
            var y_scale = d3.scale.linear().domain([1,max_order]).range([10,HEIGHT-BLOCK_HEIGHT-2])

            svg = d3.select("body")
            .select("#tree")
            .append("svg")
            .attr("width", WIDTH)
            .attr("height", HEIGHT)


             svg.selectAll("line")
             .data(dataset.branches)
             .enter()
             .append("line")
             .attr("x1",function(d){return x_scale(d.source.level) + BLOCK_WIDTH  })
             .attr("y1",function(d){return y_scale(d.source.order) + BLOCK_HEIGHT / 2})
             .attr("x2",function(d){return x_scale(d.target.level)})
             .attr("y2",function(d){return y_scale(d.target.order) + BLOCK_HEIGHT / 2})
             .attr("stroke", "black")

            svg.selectAll("rect")
            .data(dataset.leaves)
            .enter()
            .append("rect")
            .attr("width", function(d){ return BLOCK_WIDTH})
            .attr("height", function(d){ return  BLOCK_HEIGHT})
            .attr("x",function(d){return x_scale(d.level) })
            .attr("y",function(d){return y_scale(d.order)})
            .attr("fill",  "beige")
            .attr("stroke-width",1)
            .attr("stroke", "black")
            .on("mouseover", mouseOver)
            .on("mouseout", mouseOut)
            .on("click", mouseClick);

            function mouseOver(d) {

                if (!d.gold) {
                    d3.select(this)
                    .attr("fill", "yellow")

                     the_order = d.order
                     the_level = d.level

                     svg.selectAll("line")
                     .data(dataset.branches)
                     .attr("stroke", function(d) {
                                                     if ((d.source.level == the_level) && ( d.source.order == the_order ) ){
                                                        return "darkred"
                                                     }
                                                     else if ((d.target.level == the_level) && ( d.target.order == the_order ) ){
                                                        return "darkblue"
                                                     }
                                                     else {
                                                        return d.color
                                                     }

                                                  })
                     .attr("stroke-width", function(d) {
                                                     if ((d.source.level == the_level) && ( d.source.order == the_order ) ){
                                                        return 3
                                                     }
                                                     else if ((d.target.level == the_level) && ( d.target.order == the_order ) ){
                                                        return 3
                                                     }
                                                     else {
                                                        return d.width
                                                     }

                                                  })

                }
             }



            function mouseOut(d) {

                if (!d.gold) {
                    d3.select(this)
                    .attr("fill", "beige")

                     svg.selectAll("line")
                     .data(dataset.branches)
                     .attr("stroke", function(d) {return d.color})
                     .attr("stroke-width", function(d) {return d.width})
                }

            }

            function mouseClick(d) {
                 the_order = d.order
                 the_level = d.level
                if (!d.gold) {
                    d.gold = true
                    d3.select(this)
                    .attr("fill", "gold")



                     svg.selectAll("line")
                     .data(dataset.branches)
                     .attr("stroke", function(d) {
                                                     if ((d.source.level == the_level) && ( d.source.order == the_order ) ){
                                                        d.color = "red"
                                                        return "red"
                                                     }
                                                     else if ((d.target.level == the_level) && ( d.target.order == the_order ) ){
                                                        d.color = "blue"
                                                        return "blue"
                                                     }
                                                     else {
                                                        return d.color
                                                     }

                                                  })
                     .attr("stroke-width", function(d) {
                                                     if ((d.source.level == the_level) && ( d.source.order == the_order ) ){
                                                        d.width = 3
                                                        return 3
                                                     }
                                                     else if ((d.target.level == the_level) && ( d.target.order == the_order ) ){
                                                        d.width = 3
                                                        return 3
                                                     }
                                                     else {
                                                        return d.width
                                                     }

                                                  })

                }
                else {
                    d.gold = false
                    d3.select(this)
                    .attr("fill", "beige")

                     svg.selectAll("line")
                     .data(dataset.branches)
                     .attr("stroke", function(d) {
                                                     if ((d.source.level == the_level) && ( d.source.order == the_order ) ){
                                                        d.color = "black"
                                                        return "black"
                                                     }
                                                     else if ((d.target.level == the_level) && ( d.target.order == the_order ) ){
                                                        d.color = "black"
                                                        return "black"
                                                     }
                                                     else {
                                                        return d.color
                                                     }

                                                  })
                     .attr("stroke-width", function(d) {
                                                     if ((d.source.level == the_level) && ( d.source.order == the_order ) ){
                                                        d.width = 1
                                                        return 1
                                                     }
                                                     else if ((d.target.level == the_level) && ( d.target.order == the_order ) ){
                                                        d.width = 1
                                                        return 1
                                                     }
                                                     else {
                                                        return d.width
                                                     }

                                                  })                }
             }
            svg.selectAll("text")
            .data(dataset.leaves)
            .enter()
            .append("text")
            .attr("x", function(d) {return x_scale(d.level) + BLOCK_WIDTH/2})
            .attr("y", function(d) {return y_scale(d.order) + BLOCK_HEIGHT/2})
            .attr("text-anchor","middle")
            .attr("font-size", 12)
            .text(function(d) {return d.node1.name + ' - ' + d.node2.name}) // + '(' + d.depth + ')'})
            .style("pointer-events", "none")


        </script>
  </html>